<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="MyPage">

	<!-- 1대1 게시판 조회 -->
	<resultMap type="com.kh.eg.myPage.model.vo.MyPageBoard" id="myPageOneResultSet">
		<id property="boardNo" column="BOARDNO"/> <!-- 프라이머리 키값만 아이디를 줌 -->
		<result property="title" column="TITLE"/>
		<result property="boardContents" column="BOARDCONTENT"/>
		<result property="memberNo" column="MEMBERNO"/>
		<result property="writeDay" column="WRITEDAY"/>
		<result property="deleteStatus" column="DELETESTATUS"/>
		<result property="boardStatus" column="BOARDSTATUS"/>
		<result property="replyStatus" column="REPLYSTATUS"/>
		<result property="rCommentNo" column="COMMENTNO"/>
		<result property="rWriteDay" column="WRITEDAY"/>
		<result property="rContents" column="CONTENTS"/>
		<result property="rDeleteStatus" column="DELETESTATUS"/>	
		<result property="saleMemberNo" column="SMEMBERNO"/>	
		<result property="itemNo" column="ITEMNO"/>
		<result property="saleMemberName" column="SMEMBERNAME"/>
	</resultMap>
	
	<!-- 위시리스트 조회 -->
	<resultMap type="com.kh.eg.myPage.model.vo.WishList" id="wishListResultSet">
		<id property="wishlistno" column ="WISHLISTNO"/>
		<result property="categoryname" column="CATEGORYNAME"/>
		<result property="itemno" column="ITEMNO"/>
		<result property="itemname" column="ITEMNAME"/>
		<result property="startprice" column="STARTPRICE"/>
		<result property="membername" column="MEMBERNAME"/>
		<result property="endday" column="ENDDAY"/>
	</resultMap>
	
	<!-- 계좌조회 -->
	<resultMap type="com.kh.eg.myPage.model.vo.Maccount" id="selectAccount">
		<id property="accountNo" column="ACCOUNTNO"/>
		<result property="bankName" column="BANKNAME"/>
		<result property="mid" column="MEMBERNO"/>
		<result property="memberName" column="ACNAME"/>
		<result property="createDay" column="CREATEDAY"/>
	</resultMap>
	
	<!-- 유저정보 조회 -->
	<resultMap type="com.kh.eg.member.model.vo.Member" id="memberResultSet">
		<id property="mid" column="MEMBERNO"/> <!-- 프라이머리 키값만 아이디를 줌 -->
		<result property="userName" column="MEMBERNAME"/>
		<result property="userId" column="MEMBERID"/>
		<result property="userPwd" column="MEMBERPWD"/>
		<result property="account" column="ACCOUNTN"/>
		<result property="phone" column="PHONE"/>
		<result property="address" column="ADDRESS"/>
		<result property="rating" column="RATING"/>
		<result property="emoney" column="EMONEY"/>
		<result property="wdStatus" column="WDSTATUS"/>
		<result property="blStatus" column="BLSTATUS"/>
		<result property="joinDate" column="JOINDATE"/>
		<result property="email" column="EMAIL"/>
	</resultMap>
	
	<!-- 낙찰조회 -->
	<resultMap type="com.kh.eg.myPage.model.vo.WinBid" id="winBidResultSet">
		<id property="dealNo" column="DEALNO"/>
		<result property="memberNo" column="MEMBERNO"/>
		<result property="itemNo" column="ITEMNO"/>
	</resultMap>
	

	<!-- 입찰중 물품 리스트 resultMap -->
	<resultMap type="com.kh.eg.myPage.model.vo.PayTable" id="payTableResultSet">
		<id property="itemNo" column="ITEMNO"/>
		<result property="itemName" column="ITEMNAME"/>
		<result property="currentPrice" column="CURRENTPRICE"/>
		<result property="saleMemberNo" column="saleMemberNo"/>
		<result property="endDay" column="ENDDAY"/>
		<result property="endYn" column="EXITYN"/>
  	</resultMap>
	
	<!-- 구매관리 입찰중 물품 차순위 조회 -->
	<resultMap type="com.kh.eg.myPage.model.vo.PayTable" id="secondRankResultSet">
		<id property="itemNo" column="ITEMNO"/>
		<result property="rowBid" column="RANKING"/>
	</resultMap>
	
	<!-- 문의받은게시판조회 -->
	<resultMap type="com.kh.eg.myPage.model.vo.AnswerBoard" id="answerBoardResultSet">
		<id property="boardNo" column="BOARDNO"/>
		<result property="itemNo" column="ITEMNO"/>
		<result property="title" column="TITLE"/>
		<result property="replystatus" column="REPLYSTATUS"/>
		<result property="memberId" column="MEMBERID"/>
		<result property="memberName" column="MEMBERNAME"/>
		<result property="memberContents" column="BOARDCONTENT"/>
		<result property="writeDay" column="WRITEDAY"/>
	</resultMap>
	
	<!-- 게시글 조회 -->
	<select id="selectMessage" resultMap="myPageOneResultSet" parameterType="java.lang.String">
		SELECT *
		FROM BOARD  
		WHERE DELETESTATUS = 'N' AND BOARDSTATUS = 'ONEBYONE' AND MEMBERNO = #{memberNo}
		ORDER BY WRITEDAY DESC
	</select>
	
	<!-- 게시글 페이징 조회 -->
	<select id="countMessage" resultType="_int" parameterType="java.lang.String">
		SELECT COUNT(*)
		FROM BOARD  
		WHERE DELETESTATUS = 'N' AND BOARDSTATUS = 'ONEBYONE' AND MEMBERNO = #{memberNo}
	</select>
	
	<!-- 쪽지함 검색 페이징 처리 -->
	<select id="countMessageSearch" resultType="_int" parameterType="java.lang.String">
		SELECT COUNT(*)
		FROM BOARD
		WHERE DELETESTATUS = 'N' AND BOARDSTATUS = 'ONEBYONE' AND TITLE LIKE '%' || #{title} || '%' AND MEMBERNO = #{memberNo} 
	</select>
	
	<!-- 댓글 삭제 -->
	<update id="deleteReply" parameterType="int">
		UPDATE REPLY SET DELETESTATUS = 'Y' 
		WHERE BOARDNO = #{deleteNum}
	</update>
	
	<!-- 게시글 삭제 -->
	<update id="deleteMessage" parameterType="int">
		UPDATE BOARD SET DELETESTATUS = 'Y' WHERE BOARDNO = #{deleteNum}
	</update>
	
	<!-- 게시글 등록 -->
	<insert id="insertMessage" parameterType="MyPageBoard">
		INSERT INTO BOARD
		VALUES(BN_SEQ.NEXTVAL, #{title}, #{boardContents}, #{memberNo}, SYSDATE, 'N', 'ONEBYONE', 'N', 0, NULL, NULL)
	</insert>
	
	<!-- 검색으로 게시글 조회 -->
	<select id="searchMessage" resultMap="myPageOneResultSet" parameterType="java.lang.String">
		SELECT * FROM BOARD
		WHERE DELETESTATUS = 'N' 
		AND TITLE LIKE '%' || #{title} || '%' 
		AND BOARDSTATUS = 'ONEBYONE' 
		AND MEMBERNO = #{memberNo}
	</select>
	

	<!-- 위시리스트 -->
	<select id="selectWishList" resultMap="wishListResultSet" parameterType="java.lang.String">
		SELECT w.wishlistno,c.categoryname, a.itemno,a.itemname,a.startprice,m.membername,d.endday FROM WISHLIST W JOIN AUCTIONITEM A ON (W.MEMBERNO = A.MEMBERNO) JOIN CATEGORY C ON (A.CATEGORYNO = C.CATEGORYNO) JOIN MEMBER M ON(A.MEMBERNO = M.MEMBERNO) JOIN AUCTIONDETAIL D ON(D.ITEMNO = A.ITEMNO) WHERE w.deletestatus = 'N' and m.memberno =  #{memberNo}
	</select>
	
	<!-- 위시리스트 삭제 -->
	<update id="deleteWishList"  parameterType="int">
		UPDATE WISHLIST SET DELETESTATUS = 'Y' WHERE WISHLISTNO = #{wishlistno}
	</update>

	<!-- 게시글 상세보기 -->
	<select id="selectOneBoard" resultMap="myPageOneResultSet" parameterType="java.lang.String">
		SELECT * FROM BOARD 
		WHERE DELETESTATUS = 'N'
		AND BOARDSTATUS = 'ONEBYONE'
		AND BOARDNO = #{boardNo}
	</select>
	
	<!-- 회원정보 조회 -->
	<select id="selectMember" resultMap="memberResultSet" parameterType="Member">
		SELECT * FROM MEMBER WHERE MEMBERNO = #{mid}
	</select>
	
	<!-- 회원정보 수정 -->
	<update id="updateMember" parameterType="Member">
		UPDATE MEMBER SET MEMBERPWD = #{userPwd}, PHONE = #{phone}, ADDRESS = #{address} WHERE MEMBERNO = #{mid}
	</update>

	<!-- 회원정보 삭제전 거래번호가 있는지 조회 -->
	<select id="selectWinbid" resultMap="winBidResultSet" parameterType="java.lang.String">
		SELECT * FROM WINBID 
		WHERE MEMBERNO = #{mid}
	</select>

	<!-- 회원정보 삭제 -->
	<update id="deleteUserInfo" parameterType="java.lang.String">
		UPDATE MEMBER SET WDSTATUS = 'Y' WHERE MEMBERNO = #{mid}
	</update>
	
	<!-- 댓글조회 -->
	<select id="selectOneReply" resultMap="myPageOneResultSet" parameterType="java.lang.String">
		SELECT * FROM REPLY 
		WHERE BOARDNO = #{boardNo}
		AND DELETESTATUS = 'N'
	</select>
	
	<!-- 계좌조회 -->
	<select id="selectAccount" resultMap="selectAccount" parameterType="java.lang.String">
		SELECT * FROM MACCOUNT
		WHERE MEMBERNO = #{mid}
	</select>
	
	<!-- 계좌등록 -->
	<insert id="insertAccount" parameterType="Maccount">
		INSERT INTO MACCOUNT
   		VALUES(#{accountNo}, #{bankName}, #{mid}, #{memberName}, SYSDATE)
	</insert>
	
	<!-- 계좌변경 -->
	<update id="updateAccount" parameterType="Maccount">
		UPDATE MACCOUNT 
		SET ACCOUNTNO = #{accountNo}, BANKNAME = #{bankName}, MEMBERNO = #{mid}, ACNAME =  #{memberName}, CREATEDAY = SYSDATE
		WHERE MEMBERNO = #{mid}
	</update>
	
	<!-- 계좌등록이나 변경시 회원 계좌 컬럼 업데이트 -->
	<update id="updateMemberAc" parameterType="Maccount">
		UPDATE MEMBER 
		SET ACCOUNTN = #{accountNo} 
		WHERE MEMBERNO = #{mid}
	</update>
	
	<!-- 문의게시판 페이징 처리 -->
	<select id="countQueryBoard" resultType="_int" parameterType="java.lang.String">
		SELECT COUNT(*)
		FROM BOARD  
		WHERE DELETESTATUS = 'N' AND BOARDSTATUS = 'RECEIVEBOARD' AND MEMBERNO = #{memberNo}
	</select>
	
	<!-- 문의게시판 조회 -->
	<select id="selectQueryBoard" resultMap="myPageOneResultSet" parameterType="java.lang.String">
		SELECT B.BOARDNO BOARDNO, B.TITLE TITLE, B.BOARDCONTENT BOARDCONTENT, B.MEMBERNO MEMBERNO, B.WRITEDAY WRITEDAY, B.DELETESTATUS DELETESTATUS, B.BOARDSTATUS BOARDSTATUS, B.REPLYSTATUS REPLYSTATUS, B.BCOUNT BCOUNT, B.SMEMBERNO SMEMBERNO, B.ITEMNO ITEMNO, M.MEMBERNAME SMEMBERNAME 
		FROM BOARD B
        JOIN MEMBER M ON(B.SMEMBERNO = M.MEMBERNO)
		WHERE B.DELETESTATUS = 'N' 
		AND B.BOARDSTATUS = 'RECEIVEBOARD' 
		AND B.MEMBERNO = #{memberNo} 
		ORDER BY WRITEDAY DESC
	</select>
	
	<!-- 문의게시판 상세보기 -->
	<select id="selectOneQuery" resultMap="myPageOneResultSet" parameterType="java.lang.String">
		SELECT * FROM BOARD 
		WHERE DELETESTATUS = 'N'
		AND BOARDSTATUS = 'RECEIVEBOARD'
		AND BOARDNO = #{boardNo}
	</select>
	
	<!-- 문의게시판 검색 페이징 처리 -->
	<select id="searchCountQuery" resultType="_int" parameterType="java.lang.String">
		SELECT COUNT(*) 
		FROM BOARD B  
        JOIN MEMBER M ON(B.SMEMBERNO = M.MEMBERNO)
		WHERE B.DELETESTATUS = 'N' 
		AND B.BOARDSTATUS = 'RECEIVEBOARD' 
		AND B.MEMBERNO = #{memberNo}	
		<choose>
			<when test="writer != null">
				AND M.MEMBERNAME LIKE '%' || #{writer} || '%'
			</when>
			<when test="title != null">
				AND TITLE LIKE '%' || #{title} || '%'
			</when>
		</choose>
	</select>
	
	<!-- 문의게시판 검색 -->
	<select id="searchQuery" resultMap="myPageOneResultSet" parameterType="java.lang.String">
		SELECT B.BOARDNO BOARDNO, B.TITLE TITLE, B.BOARDCONTENT BOARDCONTENT, B.MEMBERNO MEMBERNO, B.WRITEDAY WRITEDAY, B.DELETESTATUS DELETESTATUS, B.BOARDSTATUS BOARDSTATUS, B.REPLYSTATUS REPLYSTATUS, B.BCOUNT BCOUNT, B.SMEMBERNO SMEMBERNO, B.ITEMNO ITEMNO, M.MEMBERNAME SMEMBERNAME 
		FROM BOARD B
        JOIN MEMBER M ON(B.SMEMBERNO = M.MEMBERNO)
		WHERE B.DELETESTATUS = 'N' 
		AND B.BOARDSTATUS = 'RECEIVEBOARD' 
		AND B.MEMBERNO = #{memberNo} 
		<choose>
			<when test="writer != null">
				AND M.MEMBERNAME LIKE '%' || #{writer} || '%'
			</when>
			<when test="title != null">
				AND TITLE LIKE '%' || #{title} || '%'
			</when>
		</choose>
		ORDER BY WRITEDAY DESC
	</select>
	
		<!-- 문의받은게시판 조회 -->
	<select id="selectanswerBoard" resultMap="answerBoardResultSet" parameterType="java.lang.String">
		SELECT B.BOARDNO, B.ITEMNO, B.TITLE, B.REPLYSTATUS, M.MEMBERID, B.WRITEDAY
		FROM BOARD B JOIN MEMBER M ON(B.MEMBERNO = M.MEMBERNO) WHERE B.BOARDSTATUS = 'RECEIVEBOARD' AND B.SMEMBERNO = #{memberNo}
	</select>
	
	<!-- 문의받은게시판 상세 조회-->
	<select id="selectdetailanswer" resultMap="answerBoardResultSet" parameterType="java.lang.String">
		SELECT B.BOARDNO, B.ITEMNO, M.MEMBERNAME, B.TITLE, B.BOARDCONTENT FROM BOARD B JOIN MEMBER M ON(B.MEMBERNO = M.MEMBERNO) WHERE B.BOARDSTATUS = 'RECEIVEBOARD' AND B.BOARDNO = #{searchTitle}
	</select>
	
	<!--//답변페이지 게시판번호 물품번호조회  -->
	<select id="reanswerDetail" resultMap="answerBoardResultSet" parameterType="java.lang.String">
		SELECT B.BOARDNO, B.ITEMNO , M.MEMBERNAME FROM BOARD B JOIN MEMBER M ON(B.MEMBERNO = M.MEMBERNO) WHERE B.BOARDSTATUS = 'RECEIVEBOARD' AND B.BOARDNO = #{answerno}
	</select>
	
<!-- ============================================================================================= -->
	<!-- 구매관리 입찰중 쿼리문들 -->
	
	<!-- 구매관리 입찰중 물품 리스트 페이징 처리 -->
	<select id="countPayList" resultType="_int" parameterType="java.lang.String"> 
		SELECT COUNT(DISTINCT MEMBERNO) FROM BID WHERE MEMBERNO = #{mid}
	</select> 
	
	<!-- 구매관리 입찰중 물품 갯수 조회 -->
	<select id="countPayListMain" resultType="_int" parameterType="java.lang.String">
		SELECT COUNT(DISTINCT ITEMNO) 
		FROM BID 
		WHERE MEMBERNO = #{userId} 
	</select>
	
	<!-- 입찰수 조회용 물품번호 조회 -->
	<select id="itemNoSearch" resultType="_int" parameterType="java.lang.String">
		SELECT DISTINCT ITEMNO 
		FROM BID 
		WHERE MEMBERNO = #{mid}
		ORDER BY ITEMNO DESC
	</select>
	
	<!-- 물품이름 조회 -->
	<select id="itemNameSearch" resultType="java.lang.String" parameterType="java.lang.String">
		SELECT DISTINCT A.ITEMNAME 
		FROM BID B 
		JOIN AUCTIONITEM A ON(B.ITEMNO = A.ITEMNO) 
		WHERE B.ITEMNO = #{itemNo}
	</select>
	
	<!-- 입찰중 내가 입력한 최고가 -->
	<select id="maxCurrentPrice" resultType="java.lang.String" parameterType="java.lang.String">
		SELECT MAX(CURRENTPRICE) FROM BID WHERE MEMBERNO = #{mid}
	</select>
	
	<!-- 입찰수 조회 -->
	<select id="bidCount" resultType="_int" parameterType="java.lang.String">
		SELECT COUNT(DISTINCT MEMBERNO) FROM BID WHERE ITEMNO = #{itemNo}
	</select>
	
	<!-- 판매자 번호 조회 -->
	<select id="selectSaleMember" resultType="_int" parameterType="java.lang.String">
		SELECT MEMBERNO FROM AUCTIONITEM WHERE ITEMNO = #{itemNo}
	</select>
		
	<!-- 판매자 이름 조회 -->	
	<select id="searchSaleMemberName" resultType="java.lang.String" parameterType="_int">
		SELECT DISTINCT M.MEMBERNAME 
		FROM AUCTIONITEM A 
		JOIN MEMBER M ON(A.MEMBERNO = M.MEMBERNO) 
		WHERE A.MEMBERNO = #{saleMemberNo}
	</select>
	
	<!-- 입찰수 랭킹처리 -->
	<select id="selectRanking" resultType="_int" parameterType="java.lang.String">
		SELECT DISTINCT  RANK() OVER (ORDER BY ITEMNO DESC) AS RANKING
		FROM BID WHERE MEMBERNO = #{mid} AND ITEMNO = #{itemNo}
	</select>	
	
	<!-- 경매 종료여부 조회 -->
	<select id="searchEndYn" resultType="java.lang.String" parameterType="java.lang.String">
		SELECT EXITYN FROM AUCTIONDETAIL WHERE ITEMNO = #{itemNo}
	</select>
	
	<!-- 경매 종료 날짜 -->
	<select id="searchEndDay" resultType="java.sql.Date" parameterType="java.lang.String">
		SELECT ENDDAY FROM AUCTIONDETAIL WHERE ITEMNO = #{itemNo}
	</select> 
	
	<!-- 구매관리 입찰중 물품 차순위 갯수 찾기 위한 아이템번호 찾기 -->
	<select id="countSecondSearchItemNo" resultMap="secondRankResultSet" parameterType="java.lang.String">
		SELECT DISTINCT ITEMNO FROM BID WHERE MEMBERNO = 11 ORDER BY ITEMNO DESC
	</select>
	
	<!-- 구매관리 입찰중 물품 차순위 갯수 -->
	<select id="countSecondRank" resultType="PayTable" parameterType="java.lang.String">
		SELECT DISTINCT RANK() OVER (ORDER BY ITEMNO DESC) AS RANKING, ITEMNO
		FROM BID
		WHERE MEMBERNO = #{userId} 
		AND ITEMNO = #{itemNo}
	</select>
	

	<!-- 낙찰받은 물품 페이징 -->
	<select id="winBidCountList" resultType="_int" parameterType="java.lang.String">
		SELECT COUNT(DISTINCT B.ITEMNO) 
		FROM BID B JOIN AUCTIONDETAIL A ON(B.ITEMNO = A.ITEMNO) 
		WHERE B.MEMBERNO = #{mid} AND A.EXITYN = 'Y'
	</select>	
	
	<!-- 낙찰받은 물품 목록 조회 -->
	<select id="selectWinBidList" resultMap="payTableResultSet" parameterType="java.lang.String">
		
	</select>

	<!--//답변페이지 게시판번호 물품번호조회  -->
	<select id="reanswerDetail" resultMap="answerBoardResultSet" parameterType="java.lang.String">
		SELECT B.BOARDNO, B.ITEMNO , M.MEMBERNAME, B.TITLE FROM BOARD B JOIN MEMBER M ON(B.MEMBERNO = M.MEMBERNO) WHERE B.BOARDSTATUS = 'RECEIVEBOARD' AND B.BOARDNO = #{answerno}
	</select>
	
	<!-- 답변페이지 답변등록-->
	<insert id="answerBoardInsert" parameterType="AnswerBoard">
		INSERT INTO REPLY VALUES(RN_SEQ.NEXTVAL, SYSDATE, #{memberContents},#{boardNo},#{memberNo},'N')
	</insert>
	
	<!-- 답변페이지 답변여부확인  -->
	<update id="answerBoardUpdate" parameterType="AnswerBoard">
		UPDATE BOARD SET REPLYSTATUS = 'Y' WHERE BOARDNO = #{boardNo}
	</update>


</mapper>